<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpressATM</title>
    <link rel="icon" type="image/svg+xml" href="/logos/expressatm-icon.svg" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img src="/logos/imag_logo.png" alt="Logo" class="brand-logo-crop" onerror="this.src='/logos/logo.png'" />
                <span>ExpressATM</span>
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-circle" id="status-indicator"></i>
                    <span id="monitoring-status">Desconectado</span>
                </span>
                <button class="btn btn-outline-light btn-sm me-2" id="theme-toggle" title="Cambiar tema">
                    <i class="fas fa-moon"></i>
                </button>
                <a class="btn btn-outline-light btn-sm me-2" href="/dashboard">
                    <i class="fas fa-chart-area"></i> Dashboard Gráfico
                </a>
                        <a class="btn btn-outline-light btn-sm me-2" href="/ai">
                            <i class="fas fa-brain"></i> Análisis IA
                        </a>
                        <button class="btn btn-outline-light btn-sm me-2" id="export-incidents-btn">
                            <i class="fas fa-file-export"></i> Exportar Incidencias
                        </button>
                                        <button class="btn btn-outline-light btn-sm me-2" id="settings-btn">
                            <i class="fas fa-cog"></i> Ajustes
                        </button>
                        <button class="btn btn-outline-light btn-sm" id="refresh-btn">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Panel de Control -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Panel de Control
                        </h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" id="start-monitoring">
                                <i class="fas fa-play"></i> Iniciar Monitoreo
                            </button>
                            <button class="btn btn-danger btn-sm me-2" id="stop-monitoring">
                                <i class="fas fa-stop"></i> Detener Monitoreo
                            </button>
                            <button class="btn btn-info btn-sm" id="manual-iteration">
                                <i class="fas fa-sync"></i> Ejecutar Manual
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-icon bg-primary">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h6>Estado del Monitoreo</h6>
                                        <span id="monitoring-state" class="badge bg-secondary">Detenido</span>
                                        <small id="next-run-countdown" class="text-muted d-block mt-1">Próxima iteración: --:--</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div id="agencies-card" class="stat-card clickable" title="Haz clic para ver todas las agencias monitoreadas">
                                    <div class="stat-icon bg-info">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h6>Agencias Monitoreadas</h6>
                                        <h4 id="total-agencies">0</h4>
                                        <small class="text-muted">
                                            <i class="fas fa-mouse-pointer"></i> Clickeable
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-icon bg-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h6>Alertas Pendientes</h6>
                                        <h4 id="pending-alerts">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card clickable" id="reported-alerts-card" title="Ver agencias con alertas reportadas hoy">
                                    <div class="stat-icon bg-success">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h6>Alertas Reportadas</h6>
                                        <h4 id="reported-alerts">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Sección de IA movida a /ai -->

        <!-- Alertas Pendientes -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-bell me-2"></i>Alertas Pendientes
                        </h5>
                        <div>
                            <select class="form-select form-select-sm" id="alert-type-filter">
                                <option value="">Todos los tipos</option>
                                <option value="threshold">Por Umbral</option>
                                <option value="growth_variation">Crecimiento</option>
                                <option value="sustained_growth">Crecimiento Sostenido</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="alerts-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Agencia</th>
                                        <th>Tipo de Alerta</th>
                                        <th>Mensaje</th>
                                        <th class="sortable" data-sort="sales" style="cursor: pointer;">
                                            Ventas Actuales <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" data-sort="balance" style="cursor: pointer;">
                                            Balance Actual <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th>Fecha/Hora</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Las alertas se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-alerts" class="text-center py-4 d-none">
                            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                            <h5>¡No hay alertas pendientes!</h5>
                            <p class="text-muted">Todas las alertas han sido reportadas o no se han detectado nuevas alertas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actividad Reciente -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Actividad Reciente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="recent-activity-table">
                                <thead>
                                    <tr>
                                        <th>Agencia</th>
                                        <th>Ventas</th>
                                        <th>Balance</th>
                                        <th>Hora</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- La actividad se cargará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Resumen de Alertas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="alerts-summary">
                            <!-- El resumen se cargará dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar acciones -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirm-message">¿Está seguro de que desea realizar esta acción?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-action">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Tendencia Global (fullscreen) -->
    <div class="modal fade" id="globalTrendModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-wave-square me-2"></i>Tendencia Global — Hoy</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted" id="global-trend-modal-updated">--</div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="globalModalSeriesSales" checked>
                                <label class="form-check-label small" for="globalModalSeriesSales">Ventas</label>
                            </div>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="globalModalSeriesBalance">
                                <label class="form-check-label small" for="globalModalSeriesBalance">Balance</label>
                            </div>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input" type="checkbox" id="globalModalSeriesBets">
                                <label class="form-check-label small" for="globalModalSeriesBets">Apuestas</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow-1" style="min-height: 50vh;">
                        <canvas id="globalTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar todas las agencias -->
    <div class="modal fade" id="allAgenciesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-building me-2"></i>Todas las Agencias Monitoreadas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="all-agencies-list">
                        <!-- La lista se cargará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar detalles de agencia -->
    <div class="modal fade" id="agencyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>Detalles de Agencia
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="agency-details">
                        <!-- Los detalles se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Movimientos Intradía (pantalla completa) -->
    <div class="modal fade" id="dayDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayDetailsTitle">
                        <i class="fas fa-calendar-day me-2"></i>Movimientos del Día
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body full-modal-body">
                    <div id="day-summary" class="row g-2 mb-3">
                        <!-- Tarjetas de resumen -->
                    </div>
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-wave-square me-2"></i>Tendencia intradía
                                </h6>
                                <div class="btn-group btn-group-sm" role="group" aria-label="Series">
                                    <input type="checkbox" class="btn-check" id="seriesSales" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="seriesSales">Ventas</label>
                                    <input type="checkbox" class="btn-check" id="seriesBalance" autocomplete="off">
                                    <label class="btn btn-outline-info" for="seriesBalance">Balance</label>
                                    <input type="checkbox" class="btn-check" id="seriesBets" autocomplete="off">
                                    <label class="btn btn-outline-warning" for="seriesBets">Apuestas</label>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="daySparkline" height="130"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow-1 table-scroll">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="day-iterations-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Hora</th>
                                        <th>Ventas</th>
                                        <th>Δ Ventas</th>
                                        <th>Balance</th>
                                        <th>Δ Balance</th>
                                        <th>Premios</th>
                                        <th>Premios Pagados</th>
                                        <th>Lotería</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Filas dinámicas -->
                                </tbody>
                            </table>
                        </div>
                        <div id="day-alerts" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuración Avanzada -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cogs me-2"></i>Configuración Avanzada del Sistema
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Configuración de Monitoreo -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-clock me-2 text-primary"></i>Configuración de Monitoreo
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="monitoring-interval" class="form-label">
                                            <i class="fas fa-sync-alt me-1"></i>Intervalo de Ejecución
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="monitoring-interval" 
                                                   min="1" max="1440" value="15" step="1">
                                            <span class="input-group-text">minutos</span>
                                        </div>
                                        <div class="form-text">
                                            <small class="text-muted">Mínimo: 1 minuto, Máximo: 24 horas (1440 min)</small>
                                        </div>
                                        
                                        <!-- Botones rápidos para tests intensivos -->
                                        <div class="mt-2">
                                            <div class="btn-group btn-group-sm w-100" role="group">
                                                <button type="button" class="btn btn-outline-danger" onclick="setQuickInterval(1)">
                                                    <i class="fas fa-rocket"></i> 1min
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" onclick="setQuickInterval(2)">
                                                    <i class="fas fa-bolt"></i> 2min
                                                </button>
                                                <button type="button" class="btn btn-outline-info" onclick="setQuickInterval(5)">
                                                    <i class="fas fa-search"></i> 5min
                                                </button>
                                                <button type="button" class="btn btn-outline-success" onclick="setQuickInterval(15)">
                                                    <i class="fas fa-check"></i> Normal
                                                </button>
                                            </div>
                                            <div class="form-text mt-1">
                                                <small>
                                                    <i class="fas fa-info-circle text-primary"></i>
                                                    <span id="interval-info">Clicks rápidos para tests intensivos</span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-eye me-1"></i>Visibilidad del Navegador
                                        </label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="browser-headless" checked>
                                            <label class="form-check-label" for="browser-headless">
                                                Modo oculto (headless)
                                            </label>
                                        </div>
                                        <div class="form-text">Desactivar para ver el navegador durante la ejecución</div>
                                    </div>

                                    <!-- Audio de Iteración -->
                                    <div class="mb-3">
                                        <label class="form-label"><i class="fas fa-music me-1"></i>Sonido de Iteración</label>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="enable-iteration-sound">
                                            <label class="form-check-label" for="enable-iteration-sound">Reproducir sonido al finalizar cada iteración</label>
                                        </div>
                                        <div class="input-group input-group-sm mb-1">
                                            <label class="input-group-text" for="iteration-sound-file"><i class="fas fa-file-audio"></i></label>
                                            <input type="file" accept="audio/*" class="form-control" id="iteration-sound-file">
                                        </div>
                                        <div class="d-flex gap-2 mb-2 flex-wrap">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="play-iteration-sound"><i class="fas fa-play"></i> Probar</button>
                                            <button type="button" class="btn btn-outline-danger btn-sm" id="clear-iteration-sound"><i class="fas fa-times"></i> Quitar personalizado</button>
                                        </div>
                                        <div class="form-text small">
                                            Usa un archivo corto (≤ 5s). Si no cargas ninguno se usará el predefinido (Sonido 1.m4a).
                                        </div>
                                        <audio id="iteration-audio" preload="auto" class="d-none"></audio>
                                    </div>

                                    <!-- Notificaciones Push de Iteración -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-bell me-1"></i>Notificaciones
                                        </label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enable-iteration-push">
                                            <label class="form-check-label" for="enable-iteration-push">
                                                Notificaciones push de cambios por iteración
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            Envía un resumen breve (agencias con cambios y nuevas en alerta) tras cada iteración. Requiere otorgar permiso del navegador.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración de Filtros -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-filter me-2 text-success"></i>Control de Filtros
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="filter-suriel" checked>
                                            <label class="form-check-label" for="filter-suriel">
                                                <i class="fas fa-ban me-1 text-danger"></i>Filtrar agencias SURIEL
                                            </label>
                                        </div>
                                        <div class="form-text">Omitir agencias que contengan "SURIEL" en el nombre</div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="filter-total-general" checked>
                                            <label class="form-check-label" for="filter-total-general">
                                                <i class="fas fa-ban me-1 text-danger"></i>Filtrar "Total General"
                                            </label>
                                        </div>
                                        <div class="form-text">Omitir registros de "Total General"</div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enable-growth-alerts" checked>
                                            <label class="form-check-label" for="enable-growth-alerts">
                                                <i class="fas fa-chart-line me-1 text-warning"></i>Alertas de crecimiento
                                            </label>
                                        </div>
                                        <div class="form-text">Detectar variaciones y crecimientos sostenidos</div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enable-threshold-alerts" checked>
                                            <label class="form-check-label" for="enable-threshold-alerts">
                                                <i class="fas fa-exclamation-triangle me-1 text-danger"></i>Alertas por umbral
                                            </label>
                                        </div>
                                        <div class="form-text">Alertas por ventas ≥ $20,000 o balance ≥ $6,000</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Umbrales -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-sliders-h me-2 text-warning"></i>Umbrales de Alertas
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="sales-threshold" class="form-label">Umbral de Ventas</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="sales-threshold" 
                                                       value="20000" min="1000" step="1000">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="balance-threshold" class="form-label">Umbral de Balance</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="balance-threshold" 
                                                       value="6000" min="1000" step="1000">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="growth-variation" class="form-label">Variación de Crecimiento</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="growth-variation" 
                                                       value="1500" min="500" step="500">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="sustained-growth" class="form-label">Crecimiento Sostenido</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="sustained-growth" 
                                                       value="500" min="100" step="100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="reset-settings">
                        <i class="fas fa-undo me-1"></i>Restaurar Defaults
                    </button>
                    <button type="button" class="btn btn-primary" id="save-settings">
                        <i class="fas fa-save me-1"></i>Guardar Configuración
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Exportar Incidencias -->
    <div class="modal fade" id="exportIncidentsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-file-export me-2"></i>Exportar Incidencias (Alertas)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="export-incidents-form">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Desde (día)</label>
                                <input type="date" class="form-control" id="export-start-day">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Hasta (día)</label>
                                <input type="date" class="form-control" id="export-end-day">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="export-reported">
                                    <option value="">Todos</option>
                                    <option value="true">Reportadas</option>
                                    <option value="false">No reportadas</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Tipo de Alerta</label>
                                <select class="form-select" id="export-alert-type">
                                    <option value="">Todos</option>
                                    <option value="threshold">Por Umbral</option>
                                    <option value="growth_variation">Crecimiento</option>
                                    <option value="sustained_growth">Crec. Sostenido</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Formato</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="export-format" id="fmt-csv" value="csv" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="fmt-csv">CSV</label>
                                    <input type="radio" class="btn-check" name="export-format" id="fmt-excel" value="excel" autocomplete="off">
                                    <label class="btn btn-outline-success" for="fmt-excel">Excel</label>
                                    <input type="radio" class="btn-check" name="export-format" id="fmt-pdf" value="pdf" autocomplete="off">
                                    <label class="btn btn-outline-danger" for="fmt-pdf">PDF</label>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="small text-muted mt-3" id="export-incidents-hint">Seleccione un rango opcional. Si lo deja vacío, exporta todas las alertas disponibles.</div>
                    <div class="alert alert-warning py-2 px-3 mt-3 d-none" id="export-incidents-empty">No hay alertas para los filtros seleccionados.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="export-incidents-run"><i class="fas fa-download me-1"></i>Descargar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Resumen de Cambios de Iteración -->
    <div class="modal fade" id="iterationChangesModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable iteration-summary-max">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-list-check me-2"></i>Resumen de Cambios de Iteración
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 d-flex flex-column" style="height:85vh;">
                    <div class="p-3 border-bottom bg-light small d-flex justify-content-between align-items-center flex-wrap gap-2" id="iterationChangesMeta">
                        <div>
                            <span class="me-3"><strong>Iteraciones acumuladas:</strong> <span id="ic-iterations-count">0</span></span>
                            <span class="me-3"><strong>Agencias con cambios:</strong> <span id="ic-agencies-count">0</span></span>
                            <span><strong>Nuevas en alerta:</strong> <span id="ic-new-agencies-count">0</span></span>
                        </div>
                        <div class="text-muted" id="ic-last-updated">Hace --</div>
                    </div>
                    <div id="iterationChangesContainer" class="p-3 flex-grow-1 overflow-auto">
                        <div class="text-muted fst-italic">Esperando primera iteración...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="form-check me-auto">
                        <input class="form-check-input" type="checkbox" id="auto-show-iteration-summary" checked>
                        <label class="form-check-label" for="auto-show-iteration-summary">
                            Mostrar este resumen automáticamente tras cada iteración
                        </label>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agencias con Alertas Reportadas -->
    <div class="modal fade" id="reportedAgenciesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>Agencias con Alertas Reportadas (hoy)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reported-agencies-list">
                        <!-- Se carga dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Recomendaciones de Optimización -->
    <div class="modal fade" id="optimizationsModal" tabindex="-1" aria-labelledby="optimizationsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="optimizationsModalLabel">Recomendaciones de Optimización</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="optimizations-modal-body">
            <!-- Contenido cargado dinámicamente -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Detalles de Estado IA -->
    <div class="modal fade" id="aiStatusModal" tabindex="-1" aria-labelledby="aiStatusModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aiStatusModalLabel">Estado del Sistema de IA</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="ai-status-modal-body">
            <!-- Datos cargados dinámicamente -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Anomalías Detectadas -->
    <div class="modal fade" id="anomaliesModal" tabindex="-1" aria-labelledby="anomaliesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="anomaliesModalLabel">Anomalías Detectadas</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="anomalies-modal-body">
            <!-- Lista de anomalías -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

        <!-- Modal Progreso de Scraping -->
        <div class="modal fade" id="scrapingProgressModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-robot me-2"></i>Progreso de Iteración (Scraping)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div id="scraping-progress-summary" class="small text-muted mb-2"></div>
                        <div class="sp-progress-total" id="scraping-progress-total"><div class="sp-progress-total-fill" id="scraping-progress-total-fill"></div></div>
                        <ul id="scraping-progress-steps" class="sp-steps list-unstyled m-0 p-0"></ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Burbuja flotante de progreso -->
        <div id="scraping-progress-bubble" class="sp-bubble d-none" title="Progreso de iteración">
            <div class="sp-bubble-inner d-flex align-items-center">
                <div class="sp-icon me-1" id="sp-bubble-icon">
                    <span class="spinner-border spinner-border-sm"></span>
                </div>
                <div class="flex-grow-1">
                    <div class="sp-label" id="sp-bubble-label">Scraping…</div>
                    <div class="sp-mini-bar mt-1">
                        <div class="sp-mini-bar-fill" id="sp-bubble-bar" style="width:0%;"></div>
                    </div>
                </div>
                <button type="button" id="sp-bubble-close" class="btn btn-link p-0 ms-2 text-decoration-none text-muted" aria-label="Cerrar" style="font-size:14px;line-height:1;">&times;</button>
            </div>
        </div>

    <!-- Modal de Predicciones de Fallos -->
    <div class="modal fade" id="predictionsModal" tabindex="-1" aria-labelledby="predictionsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="predictionsModalLabel">Detalles de Predicción de Fallos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="predictions-modal-body">
            <!-- Detalles de predicción -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast para notificaciones -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notification-toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Mensaje de notificación -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>