@echo off
setlocal enabledelayedexpansion
echo.
echo ========================================
echo    ExpressATM - Instalador Universal
echo ========================================
echo.
echo üéØ Este script realiza TODA la instalacion automaticamente:
echo    ‚úÖ Verificacion del sistema
echo    ‚úÖ Creacion de entorno virtual
echo    ‚úÖ Instalacion de dependencias
echo    ‚úÖ Configuracion de ChromeDriver
echo    ‚úÖ Verificacion final
echo    ‚úÖ Prueba de funcionamiento
echo.
echo ‚è±Ô∏è  Tiempo estimado: 3-5 minutos
echo.
set /p CONTINUE="¬øContinuar con la instalacion completa? (S/N): "
if /i not "%CONTINUE%"=="S" (
    echo ‚ùå Instalacion cancelada
    pause
    exit /b 0
)

echo.
echo ==========================================
echo    FASE 1: VERIFICACION DEL SISTEMA
echo ==========================================

REM ===== VERIFICAR PYTHON =====
echo.
echo üîç [1/8] Verificando Python...

REM Probar diferentes comandos de Python
set PYTHON_CMD=
set PYTHON_VERSION=

REM Probar 'python'
python --version >nul 2>&1
if %errorlevel% equ 0 (
    set PYTHON_CMD=python
    for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
    goto python_found
)

REM Probar 'python3'
python3 --version >nul 2>&1
if %errorlevel% equ 0 (
    set PYTHON_CMD=python3
    for /f "tokens=2" %%i in ('python3 --version 2^>^&1') do set PYTHON_VERSION=%%i
    goto python_found
)

REM Probar 'py' (Python Launcher)
py --version >nul 2>&1
if %errorlevel% equ 0 (
    set PYTHON_CMD=py
    for /f "tokens=2" %%i in ('py --version 2^>^&1') do set PYTHON_VERSION=%%i
    goto python_found
)

REM Python no encontrado
echo ‚ùå ERROR: Python no esta instalado o no esta en PATH
echo.
echo üîß SOLUCION REQUERIDA:
echo 1. Instalar Python 3.8+ desde: https://python.org/downloads
echo 2. ‚úÖ IMPORTANTE: Marcar "Add Python to PATH" durante instalacion
echo 3. Reiniciar PC
echo 4. Ejecutar este script nuevamente
echo.
echo üí° ALTERNATIVA - Verificar instalacion existente:
echo    ‚Ä¢ Buscar "python.exe" en tu PC
echo    ‚Ä¢ Agregar carpeta a PATH manualmente
echo    ‚Ä¢ O reinstalar Python con opcion PATH marcada
echo.
pause
exit /b 1

:python_found
echo ‚úÖ Python %PYTHON_VERSION% encontrado (comando: %PYTHON_CMD%)

REM ===== VERIFICAR GIT (opcional) =====
echo.
echo üîç [2/8] Verificando Git...
git --version >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ö†Ô∏è  Git no encontrado (opcional)
    echo üí° Para actualizaciones automaticas instalar desde: https://git-scm.com
    set GIT_AVAILABLE=false
) else (
    echo ‚úÖ Git disponible
    set GIT_AVAILABLE=true
)

REM ===== VERIFICAR CHROME =====
echo.
echo üîç [3/8] Verificando Google Chrome...
set CHROME_PATH=""
if exist "C:\Program Files\Google\Chrome\Application\chrome.exe" (
    set CHROME_PATH="C:\Program Files\Google\Chrome\Application\chrome.exe"
)
if exist "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" (
    set CHROME_PATH="C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
)
if exist "%LOCALAPPDATA%\Google\Chrome\Application\chrome.exe" (
    set CHROME_PATH="%LOCALAPPDATA%\Google\Chrome\Application\chrome.exe"
)

if %CHROME_PATH%=="" (
    echo ‚ö†Ô∏è  Google Chrome no encontrado
    echo üí° RECOMENDACION: Instalar Chrome desde https://www.google.com/chrome/
    echo    (El scraping funcionara con limitaciones)
    set CHROME_AVAILABLE=false
) else (
    echo ‚úÖ Chrome encontrado en: %CHROME_PATH%
    set CHROME_AVAILABLE=true
)

echo.
echo ==========================================
echo    FASE 2: PREPARACION DEL ENTORNO
echo ==========================================

REM ===== LIMPIAR ENTORNO VIRTUAL CORRUPTO =====
echo.
echo üßπ [4/8] Preparando entorno virtual...
if exist "venv" (
    echo Eliminando entorno virtual existente (puede tener rutas incorrectas)
    rmdir /S /Q venv
    if %errorlevel% neq 0 (
        echo ‚ö†Ô∏è  No se pudo eliminar completamente, continuando
    )
)

echo ‚úÖ Creando nuevo entorno virtual
%PYTHON_CMD% -m venv venv
if %errorlevel% neq 0 (
    echo ‚ùå ERROR: No se pudo crear entorno virtual
    echo üí° Verifica que Python este correctamente instalado
    pause
    exit /b 1
)

echo ‚úÖ Activando entorno virtual...
call venv\Scripts\activate.bat
if %errorlevel% neq 0 (
    echo ‚ùå ERROR: No se pudo activar entorno virtual
    pause
    exit /b 1
)

echo.
echo ==========================================
echo    FASE 3: INSTALACION DE DEPENDENCIAS
echo ==========================================

REM ===== ACTUALIZAR PIP =====
echo.
echo üì¶ [5/8] Actualizando pip...
%PYTHON_CMD% -m pip install --upgrade pip --quiet
if %errorlevel% neq 0 (
    echo ‚ö†Ô∏è  Advertencia: No se pudo actualizar pip, continuando
)

REM ===== INSTALAR DEPENDENCIAS =====
echo.
echo üìö [6/8] Instalando dependencias de ExpressATM...
echo    (Esto puede tomar 2-3 minutos)

if not exist "requirements.txt" (
    echo ‚ùå ERROR: requirements.txt no encontrado
    echo üí° Verifica que estas en el directorio correcto de ExpressATM
    pause
    exit /b 1
)

%PYTHON_CMD% -m pip install -r requirements.txt --quiet
if %errorlevel% neq 0 (
    echo ‚ùå ERROR instalando dependencias
    echo.
    echo üîß Intentando instalacion de dependencias criticas
    %PYTHON_CMD% -m pip install fastapi uvicorn pandas selenium numpy sqlalchemy --quiet
    
    echo üîÑ Reintentando instalacion completa
    %PYTHON_CMD% -m pip install -r requirements.txt
    
    if %errorlevel% neq 0 (
        echo ‚ùå ERROR: No se pudieron instalar todas las dependencias
        echo üí° Revisa tu conexion a internet y intenta nuevamente
        pause
        exit /b 1
    )
)

echo ‚úÖ Dependencias instaladas exitosamente

REM ===== VERIFICAR DEPENDENCIAS CRITICAS =====
echo.
echo üß™ Verificando dependencias criticas...
%PYTHON_CMD% -c "import fastapi, pandas, selenium; print('‚úÖ Dependencias principales verificadas')" 2>nul
if %errorlevel% neq 0 (
    echo ‚ö†Ô∏è  Algunas dependencias pueden faltar, pero continuando
)

echo.
echo ==========================================
echo    FASE 4: CONFIGURACION DE CHROMEDRIVER
echo ==========================================

REM ===== INSTALAR CHROMEDRIVER =====
echo.
echo üåê [7/8] Configurando ChromeDriver...

if not exist "drivers" mkdir drivers

if "%CHROME_AVAILABLE%"=="true" (
    echo üì• Descargando ChromeDriver automaticamente
    
    REM Obtener version de Chrome
    for /f "tokens=*" %%i in ('powershell -command "& {(Get-ItemProperty '%CHROME_PATH%').VersionInfo.ProductVersion}"') do set CHROME_VERSION=%%i
    
    if not "!CHROME_VERSION!"=="" (
        for /f "tokens=1 delims=." %%a in ("!CHROME_VERSION!") do set CHROME_MAJOR=%%a
        echo üìç Detectada version Chrome: !CHROME_VERSION! (Principal: !CHROME_MAJOR!)
        
        REM Descargar ChromeDriver
        powershell -command "& {try { $latest = Invoke-RestMethod -Uri 'https://chromedriver.storage.googleapis.com/LATEST_RELEASE_!CHROME_MAJOR!' -ErrorAction Stop; $url = 'https://chromedriver.storage.googleapis.com/' + $latest + '/chromedriver_win32.zip'; Invoke-WebRequest -Uri $url -OutFile 'drivers\chromedriver.zip' -ErrorAction Stop; Expand-Archive -Path 'drivers\chromedriver.zip' -DestinationPath 'drivers\' -Force; Remove-Item 'drivers\chromedriver.zip' -Force; Write-Host '‚úÖ ChromeDriver instalado exitosamente' } catch { Write-Host '‚ùå Error:', $_.Exception.Message; exit 1 }}"
        
        if %errorlevel% equ 0 (
            echo ‚úÖ ChromeDriver configurado exitosamente
        ) else (
            echo ‚ö†Ô∏è  Error descargando ChromeDriver automaticamente
            echo üí° El scraping puede fallar, instalar manualmente desde: https://chromedriver.chromium.org
        )
    ) else (
        echo ‚ö†Ô∏è  No se pudo detectar version de Chrome
        echo üí° ChromeDriver se puede instalar manualmente despues
    )
) else (
    echo ‚ö†Ô∏è  Chrome no detectado, saltando instalacion de ChromeDriver
    echo üí° Para scraping, instalar Chrome y ejecutar: update_chromedriver.bat
)

echo.
echo ==========================================
echo    FASE 5: VERIFICACION FINAL
echo ==========================================

REM ===== VERIFICAR INSTALACION =====
echo.
echo üîç [8/8] Verificando instalacion completa...

echo.
echo üìç Archivos principales:
if exist "run.py" (echo    ‚úÖ run.py) else (echo    ‚ùå run.py FALTANTE)
if exist "requirements.txt" (echo    ‚úÖ requirements.txt) else (echo    ‚ùå requirements.txt FALTANTE)  
if exist "backend\app\main.py" (echo    ‚úÖ backend\app\main.py) else (echo    ‚ùå backend\app\main.py FALTANTE)

echo.
echo üìç Entorno virtual:
venv\Scripts\python.exe --version 2>nul
if %errorlevel% equ 0 (
    echo    ‚úÖ Entorno virtual funcional
) else (
    echo    ‚ùå Problemas con entorno virtual
)

echo.
echo üìç ChromeDriver:
if exist "drivers\chromedriver.exe" (
    drivers\chromedriver.exe --version 2>nul
    if %errorlevel% equ 0 (
        echo    ‚úÖ ChromeDriver funcional
    ) else (
        echo    ‚ö†Ô∏è  ChromeDriver presente pero puede tener problemas
    )
) else (
    echo    ‚ö†Ô∏è  ChromeDriver no instalado
)

REM ===== CREAR ACCESO DIRECTO =====
echo.
echo üñ•Ô∏è  Creando acceso directo en escritorio
set "scriptPath=%~dp0run.bat"
set "desktopPath=%USERPROFILE%\Desktop"
set "shortcutPath=%desktopPath%\ExpressATM.lnk"

powershell -command "& {try { $WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%shortcutPath%'); $Shortcut.TargetPath = '%scriptPath%'; $Shortcut.WorkingDirectory = '%~dp0'; $Shortcut.Description = 'ExpressATM - Sistema de Monitoreo'; $Shortcut.Save(); Write-Host '‚úÖ Acceso directo creado' } catch { Write-Host '‚ö†Ô∏è No se pudo crear acceso directo' }}"

echo.
echo ==========================================
echo           INSTALACION COMPLETADA
echo ==========================================
echo.
echo üéâ ¬°ExpressATM instalado exitosamente!
echo.
echo üöÄ FORMAS DE EJECUTAR:
echo    1. Doble clic en "ExpressATM" en el escritorio
echo    2. Ejecutar: run.bat
echo    3. Comando: %PYTHON_CMD% run.py
echo.
echo üåê ACCESO WEB (despues de ejecutar):
echo    ‚Ä¢ Panel Principal: http://localhost:8000
echo    ‚Ä¢ Dashboard: http://localhost:8000/dashboard
echo    ‚Ä¢ Analisis IA: http://localhost:8000/ai
echo.
echo üí° SCRIPTS UTILES:
echo    ‚Ä¢ update.bat           - Actualizar desde GitHub
echo    ‚Ä¢ check_updates.bat    - Verificar actualizaciones
echo    ‚Ä¢ check_system.bat     - Diagnosticar problemas
echo.
echo üìö DOCUMENTACION:
echo    ‚Ä¢ README.md            - Guia principal
echo    ‚Ä¢ INSTALACION_EQUIPO.md - Guia del equipo
echo    ‚Ä¢ ACTUALIZACION.md     - Guia de actualizacion
echo.

REM ===== PROBAR EJECUCION =====
echo.
set /p TEST_RUN="¬øProbar ExpressATM ahora? (S/N): "
if /i "%TEST_RUN%"=="S" (
    echo.
    echo üöÄ Iniciando ExpressATM
    echo    (Se abrira en el navegador automaticamente)
    echo    (Presiona Ctrl+C para detener)
    echo.
    timeout /t 3 /nobreak >nul
    %PYTHON_CMD% run.py
) else (
    echo.
    echo ‚úÖ Instalacion completa. Para ejecutar usa: run.bat
)

echo.
pause
